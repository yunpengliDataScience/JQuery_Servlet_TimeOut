<html>
<head>
<link rel="stylesheet"
	href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script type="text/javascript">
	
	var sessionTimeOutSeconds = 0;
	var session_expired_timer = 0;
	var notification_timer = 0;
	var remaining_seconds = 0;
	var display_remaining_seconds = 0;
	var countdownInterval = null;

	function getContextPath() {
		return window.location.pathname.substring(0, window.location.pathname
				.indexOf("/", 2));
	}

	function redirectLogout() {

		var contextPath = getContextPath();
		
		url = window.location.protocol + "//" + window.location.host + contextPath+"/logout.html";
		
		window.location = url;
		
	}

	//Display timeout dialog
	function showTimeOutDialog() {

		$("#dialog").dialog({
			autoOpen : true,
			modal : false,
			title : "Session Expiring",
			buttons : {
				Ok : function() {
					refreshSessionStartTimer();
					
					$(this).dialog('close');
				},
				Close : function() {
					$(this).dialog('close');
				}
			}
		});

	}

	function logoutRedirect() {
		
		redirectLogout();
	}

	function retrieveSessionTimeOut(data){
		//alert(data);
		
		//JSon object: {"sessionTimeOut": xx }
		jsonObj = jQuery.parseJSON(data);
		
		//reset sessionTimeOutSeconds
		sessionTimeOutSeconds = parseInt(jsonObj.sessionTimeOut);
		//alert("sessionTimeOutSeconds="+sessionTimeOutSeconds);
	}
	
	function refreshSessionStartTimer() {
		
		if(countdownInterval != null){
			
			//javascript build-in function for stop timer
			clearInterval(countdownInterval);
		}
		  
		//Refresh Session.
		initSessionTimeOut();
		
		//Set up count down timer for redirecting page to logout page if no action is detected.
		display_remaining_seconds = 30; //the last seconds for display
		session_expired_timer = sessionTimeOutSeconds * 1000; //milliseconds
		remaining_seconds = sessionTimeOutSeconds;
		notification_timer = session_expired_timer - display_remaining_seconds * 1000; // The time when notification popup shows up.
		
		//alert("session_expired_timer="+session_expired_timer);
		//alert("notification_timer="+notification_timer);
		//alert("remaining_seconds="+remaining_seconds);
		//alert("display_remaining_seconds="+display_remaining_seconds);

		//Set up timer for displaying session timeout dialog.
		setTimeout(showTimeOutDialog, notification_timer);

		countdownInterval = setInterval(function() {
			remaining_seconds--;
			
			//Display remaining seconds instantly.
			$("#seconds").html(remaining_seconds);
			
			$("#timeLeft").html(remaining_seconds);
			
		    if(remaining_seconds <= 0){
		    	//Redirect to logout when remaining seconds run out.
		    	logoutRedirect();
		    } 
		    
		}, 1000);
	}

	function initSessionTimeOut(){
		
		var contextPath = getContextPath();
		
		servletUrl = window.location.protocol + "//" + window.location.host + contextPath + "/sessionTimeOutRetrievalServlet";
	
		//alert(servletUrl);
		
		//Use ajax to touch the session and get the session timeout value from the sever.
        jQuery.ajax({
            url: servletUrl,
            success: function (result) {
            	retrieveSessionTimeOut(result);
            },
            async: false
        });
	}
	
	//Start point when document is ready.
	//Same as $(document).ready(function() {});
	$(function() {

		refreshSessionStartTimer();

	});

</script>

<style>

#dialog {
  display: none;
}
</style>

</head>

<body>
	<center>
		<h1>Jquery Servlet Timeout</h1>
		<br/>
		<h1>Seconds Left Since Session Refreshed: <span id="timeLeft"/></h1>
	</center>
	
	<div id="dialog">
		Your session will expire in&nbsp;<span id="seconds"></span>&nbsp;seconds.<br />
		Do you want to reset?
	</div>

</body>
</html>